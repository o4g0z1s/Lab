<!DOCTYPE html>
<html lang="ja">
<head>
<title>ğš‚ğš’ğšğšœğšğšŠ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><text x='16' y='24' font-size='24' text-anchor='middle' fill='orange'>ğŸŒ</text></svg>">
<meta charset="UTF-8">
<style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #ffd;
    }

    #simulationCanvas {
        border: none;
        background-color: none;
        height: 70vmin;
        width: 70vmin;
        filter: blur(50px) saturate(200%) brightness(200%);
    }
</style>
</head>
<body>

<canvas id="simulationCanvas"></canvas>

<script>
    // --- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬è¨­å®š ---
    const GRID_SIZE = 150;          // ç”»é¢ã®ãƒ”ã‚¯ã‚»ãƒ«æ•°ï¼ˆä¸€è¾ºï¼‰ã€‚
    const CELL_SIZE = 5;            // 1ãƒ”ã‚¯ã‚»ãƒ«ã®æç”»ã‚µã‚¤ã‚ºï¼ˆå˜ä½: pxï¼‰ã€‚
    const INITIAL_FACTIONS = 3;     // åˆæœŸå‹¢åŠ›ã®æ•°ã€‚
    const EXPANSION_CHANCE = 0.7;   // å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã€ãã‚Œãã‚Œã®å‹¢åŠ›ãŒæ‹¡å¤§ã‚’è©¦ã¿ã‚‹ç¢ºç‡ã€‚
    const NEW_FACTION_THRESHOLD = 0.1; // å…¨ä½“ã®ä½•å‰²ãŒå é ˜ã•ã‚ŒãŸã‚‰æ–°èˆˆå‹¢åŠ›ãŒç¾ã‚Œå§‹ã‚ã‚‹ã‹ã€‚
    const NEW_FACTION_CHANCE = 0.05; // æ¡ä»¶ã‚’æº€ãŸã—ãŸå¾Œã®å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§æ–°èˆˆå‹¢åŠ›ãŒæ–°ãŸã«å‡ºç¾ã™ã‚‹ç¢ºç‡ã€‚
    const SIMULATION_SPEED = 50;    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰ã€‚æ•°å€¤ãŒå¤§ãã„ã»ã©é…ããªã‚‹ã€‚

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    const canvas = document.getElementById('simulationCanvas');
    const ctx = canvas.getContext('2d');

    let grid = [];      // å„ãƒ”ã‚¯ã‚»ãƒ«ã®æ‰€æœ‰è€…æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹2æ¬¡å…ƒé…åˆ—
    let factions = [];  // å„å‹¢åŠ›ã®æƒ…å ±ï¼ˆID, è‰², ã‚µã‚¤ã‚º, å¹´é½¢ï¼‰ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
    let nextFactionId = 1; // æ¬¡ã«ç”Ÿæˆã•ã‚Œã‚‹å‹¢åŠ›ã®ID

    /**
     * ãƒ©ãƒ³ãƒ€ãƒ ãª16é€²æ•°ã®ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
     */
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    /**
     * ã‚°ãƒªãƒƒãƒ‰å†…ã®ãƒ©ãƒ³ãƒ€ãƒ ãªåº§æ¨™ã‚’è¿”ã™é–¢æ•°
     */
    function getRandomCell() {
        const x = Math.floor(Math.random() * GRID_SIZE);
        const y = Math.floor(Math.random() * GRID_SIZE);
        return { x, y };
    }

    /**
     * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
     */
    function init() {
        canvas.width = GRID_SIZE * CELL_SIZE;
        canvas.height = GRID_SIZE * CELL_SIZE;
        grid = Array(GRID_SIZE).fill(null).map(() => Array(GRID_SIZE).fill(0));
        factions = [];
        nextFactionId = 1;

        for (let i = 0; i < INITIAL_FACTIONS; i++) {
            createFaction();
        }

        gameLoop();
    }

    /**
     * æ–°ã—ã„å‹¢åŠ›ã‚’ç”Ÿæˆã—ã€ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ”ã‚¯ã‚»ãƒ«ã«é…ç½®ã™ã‚‹é–¢æ•°
     */
    function createFaction() {
        const startPos = getRandomCell();
        if (!startPos) return;

        const originalFactionId = grid[startPos.y][startPos.x];
        if (originalFactionId !== 0) {
            const originalFaction = factions.find(f => f.id === originalFactionId);
            if (originalFaction) {
                originalFaction.size--;
            }
        }
        
        const newFaction = {
            id: nextFactionId,
            color: getRandomColor(), // å…¨ã¦ã®å‹¢åŠ›ãŒãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã‚’æŒã¤
            size: 1,
            age: 0,
            // isImmortal ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯å»ƒæ­¢
        };

        factions.push(newFaction);
        grid[startPos.y][startPos.x] = newFaction.id;
        nextFactionId++;
    }

    /**
     * ç¾åœ¨ã®ã‚°ãƒªãƒƒãƒ‰ã®çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã™ã‚‹é–¢æ•°
     */
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let y = 0; y < GRID_SIZE; y++) {
            for (let x = 0; x < GRID_SIZE; x++) {
                const factionId = grid[y][x];
                if (factionId !== 0) {
                    const faction = factions.find(f => f.id === factionId);
                    if (faction) {
                        ctx.fillStyle = faction.color;
                        ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }
        }
    }
    
    /**
     * å„å‹¢åŠ›ã®æ‹¡å¤§ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
     */
    function expandFactions() {
        factions = factions.filter(f => f.size > 0);

        factions.forEach(faction => {
            faction.age++;

            if (Math.random() > EXPANSION_CHANCE) return;

            // åŸºæœ¬å¼·åº¦ã«ã€å‹¢åŠ›IDã«åŸºã¥ã„ãŸãƒœãƒ¼ãƒŠã‚¹ã‚’åŠ ç®—ã™ã‚‹ã€‚
            // ã“ã‚Œã«ã‚ˆã‚Šã€å¾Œã‹ã‚‰ç”Ÿã¾ã‚ŒãŸå‹¢åŠ›ã»ã©åˆæœŸã®æœ€å¤§æ‹¡å¤§èƒ½åŠ›ãŒé«˜ããªã‚‹ã€‚
            // ãŸã ã—ã€æ™‚é–“çµŒé(age)ã«ã‚ˆã‚‹è¡°é€€ã¯å…¨ã¦ã®å‹¢åŠ›ã«é©ç”¨ã•ã‚Œã‚‹ã€‚
            const initialPower = 15 + (faction.id * 2); // IDãŒä¸ŠãŒã‚‹ã”ã¨ã«åŸºæœ¬å¼·åº¦ãŒå¢—ãˆã‚‹
            const decay = Math.exp(-faction.age / 1800);  // è¡°é€€ç‡ã¯å°‘ã—æ—©ã‚ã«èª¿æ•´
            
            const maxExpansion = Math.max(1, Math.round(initialPower * decay)) + 1;
            const expansionCount = Math.floor(Math.random() * maxExpansion) + 1;

            let candidates = [];
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    if (grid[y][x] === faction.id) {
                        const neighbors = [
                            { nx: x, ny: y - 1 }, { nx: x, ny: y + 1 },
                            { nx: x - 1, ny: y }, { nx: x + 1, ny: y },
                        ];
                        neighbors.forEach(({ nx, ny }) => {
                            if (nx >= 0 && nx < GRID_SIZE && ny >= 0 && ny < GRID_SIZE && grid[ny][nx] !== faction.id) {
                                candidates.push({ x: nx, y: ny });
                            }
                        });
                    }
                }
            }
            
            if (candidates.length === 0) return;

            const uniqueCandidates = [...new Set(candidates.map(c => JSON.stringify(c)))].map(s => JSON.parse(s));
            shuffleArray(uniqueCandidates);

            for (let i = 0; i < expansionCount && i < uniqueCandidates.length; i++) {
                const cell = uniqueCandidates[i];
                const originalFactionId = grid[cell.y][cell.x];

                if (originalFactionId !== faction.id) {
                    if (originalFactionId !== 0) {
                        const originalFaction = factions.find(f => f.id === originalFactionId);
                        if (originalFaction) {
                            originalFaction.size--;
                        }
                    }
                    grid[cell.y][cell.x] = faction.id;
                    faction.size++;
                }
            }
        });
    }

    /**
     * é…åˆ—ã®è¦ç´ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆã‚‹é–¢æ•°
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    /**
     * æ–°èˆˆå‹¢åŠ›ã®å‡ºç¾æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¿…è¦ã§ã‚ã‚Œã°ç”Ÿæˆã™ã‚‹é–¢æ•°
     */
    function spawnNewFaction() {
        const totalCells = GRID_SIZE * GRID_SIZE;
        const occupiedCells = factions.reduce((sum, f) => sum + f.size, 0);

        if (occupiedCells / totalCells > NEW_FACTION_THRESHOLD && Math.random() < NEW_FACTION_CHANCE) {
            createFaction();
        }
    }

    /**
     * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—é–¢æ•°
     */
    function gameLoop() {
        expandFactions();
        spawnNewFaction();
        draw();
        
        setTimeout(gameLoop, SIMULATION_SPEED);
    }

    // --- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ---
    init();
</script>

</body>
</html>